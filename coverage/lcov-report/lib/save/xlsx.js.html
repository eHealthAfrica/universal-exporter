<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for lib/save/xlsx.js</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="../../prettify.css">
    <link rel="stylesheet" href="../../base.css">
    <style type='text/css'>
        div.coverage-summary .sorter {
            background-image: url(../../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class="header medium">
    <h1>Code coverage report for <span class="entity">lib/save/xlsx.js</span></h1>
    <h2>
        Statements: <span class="metric">66.15% <small>(43 / 65)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        Branches: <span class="metric">65.38% <small>(17 / 26)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        Functions: <span class="metric">66.67% <small>(4 / 6)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        Lines: <span class="metric">67.24% <small>(39 / 58)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        Ignored: <span class="metric"><span class="ignore-none">none</span></span> &nbsp;&nbsp;&nbsp;&nbsp;
    </h2>
    <div class="path"><a href="../../index.html">All files</a> &#187; <a href="index.html">lib/save/</a> &#187; xlsx.js</div>
</div>
<div class="body">
<pre><table class="coverage">
<tr><td class="line-count">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110</td><td class="line-coverage"><span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">2</span>
<span class="cline-any cline-yes">2</span>
<span class="cline-any cline-yes">2</span>
<span class="cline-any cline-yes">2</span>
<span class="cline-any cline-yes">4</span>
<span class="cline-any cline-yes">4</span>
<span class="cline-any cline-yes">4</span>
<span class="cline-any cline-yes">4</span>
<span class="cline-any cline-yes">4</span>
<span class="cline-any cline-yes">4</span>
<span class="cline-any cline-yes">4</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-yes">4</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-yes">4</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2</span>
<span class="cline-any cline-yes">2</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">2</span>
<span class="cline-any cline-yes">2</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2</span>
<span class="cline-any cline-yes">2</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2</span>
<span class="cline-any cline-yes">2</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2</span>
<span class="cline-any cline-yes">2</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">2</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2</span>
<span class="cline-any cline-yes">2</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">var XLSX = global.XLSX || require('xlsx'); // support client side dep
var BufferToStream = require('./_bufferToStream');
var debug = require('debug')('exporter:xlsx');
&nbsp;
// via https://gist.github.com/SheetJSDev/88a3ca3533adf389d13c
// converts an array of data into the cell format, that has
// column (c), row (r), value (v) and type (t)
// also figures out number of rows and cols of the doc,
// and writes that as the range
function sheetFromArrayOfArrays(data) {
  var ws = {};
  var range = {s: {c: 10000000, r: 10000000}, e: {c: 0, r: 0 }};
  for (var R = 0; R != data.length; ++R) {
    for (var C = 0; C != data[R].length; ++C) {
      if (range.s.r &gt; R) range.s.r = R;
      if (range.s.c &gt; C) range.s.c = C;
      <span class="missing-if-branch" title="if path not taken" >I</span>if (range.e.r &lt; R) <span class="cstat-no" title="statement not covered" >range.e.r = R;</span>
      if (range.e.c &lt; C) range.e.c = C;
      var cell = {v: data[R][C] };
      <span class="missing-if-branch" title="if path not taken" >I</span>if (cell.v == null) <span class="cstat-no" title="statement not covered" >continue;</span>
      var cell_ref = XLSX.utils.encode_cell({c: C, r: R});
&nbsp;
      // Type conversion should have been done in the row-reading function
      <span class="missing-if-branch" title="if path not taken" >I</span>if (typeof cell.v === 'number') {
<span class="cstat-no" title="statement not covered" >        cell.t = 'n';</span>
      } else <span class="missing-if-branch" title="if path not taken" >I</span>if (typeof cell.v === 'boolean') {
<span class="cstat-no" title="statement not covered" >        cell.t = 'b';</span>
      } else <span class="missing-if-branch" title="if path not taken" >I</span>if (cell.v instanceof Date) {
<span class="cstat-no" title="statement not covered" >        cell.t = 'n'; <span class="cstat-no" title="statement not covered" ></span>cell.z = XLSX.SSF._table[14];</span>
<span class="cstat-no" title="statement not covered" >        cell.v = cell.v.toISOString();</span>
      } else {
        cell.t = 's';
      }
&nbsp;
      ws[cell_ref] = cell;
    }
  }
  <span class="missing-if-branch" title="else path not taken" >E</span>if (range.s.c &lt; 10000000) ws['!ref'] = XLSX.utils.encode_range(range);
  return ws;
}
&nbsp;
<span class="fstat-no" title="function not covered" >function s2ab(s) {</span>
<span class="cstat-no" title="statement not covered" >  debug('start s2ab');</span>
<span class="cstat-no" title="statement not covered" >  var buf = new ArrayBuffer(s.length);</span>
<span class="cstat-no" title="statement not covered" >  var buffer = new Buffer(buf.byteLength);</span>
<span class="cstat-no" title="statement not covered" >  for (var i = 0; i != s.length; ++i) {</span>
<span class="cstat-no" title="statement not covered" >    buffer[i] = s.charCodeAt(i) &amp; 0xFF;</span>
  }
&nbsp;
<span class="cstat-no" title="statement not covered" >  debug('complete s2ab');</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >  return buffer;</span>
}
&nbsp;
<span class="fstat-no" title="function not covered" >function pipe(data, stream) {</span>
<span class="cstat-no" title="statement not covered" >  debug('start pipe');</span>
<span class="cstat-no" title="statement not covered" >  var write = s2ab(XLSX.write(data, {</span>
    bookType: 'xlsx',
    // this costs a lot of memory, and removed takes the write time from
    // 10 seconds to 1 second for ~7000 rows of data.
    // bookSST: true,
    type: 'binary',
  }));
&nbsp;
<span class="cstat-no" title="statement not covered" >  debug('XLSX.write complete');</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >  new BufferToStream(write).pipe(stream);</span>
<span class="cstat-no" title="statement not covered" >  return data;</span>
}
&nbsp;
function parse(data, filename) {
  debug('start parse');
  <span class="missing-if-branch" title="if path not taken" >I</span>if (Object.keys(XLSX).length === 0) {
    // xlsx isn't installed
<span class="cstat-no" title="statement not covered" >    return Promise.reject(new Error('XLSX library is not available'));</span>
  }
  return new Promise(function (resolve, reject) {
    <span class="missing-if-branch" title="if path not taken" >I</span>if (!(/\.xlsx$/.test(filename))) {
<span class="cstat-no" title="statement not covered" >      filename = filename + '.xlsx';</span>
    }
    var name = filename.split('.')[0];
    var workBook = {
      SheetNames: [name],
      Sheets: {},
    };
&nbsp;
    workBook.Sheets[name] = sheetFromArrayOfArrays(data);
    debug('sheetFromArrayOfArrays done');
&nbsp;
    resolve(workBook);
  });
};
&nbsp;
function write(data, filename, altfn) {
  <span class="missing-if-branch" title="if path not taken" >I</span>if (altfn) { // allows the user to change the filename on the fly
<span class="cstat-no" title="statement not covered" >    filename = altfn;</span>
  }
&nbsp;
  XLSX.writeFile(data, filename);
  return data;
}
&nbsp;
module.exports = {
  parse: parse,
  write: write,
  pipe: pipe,
  name: 'xlsx',
  mime: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
  version: '1.0.0',
};</pre></td></tr>
</table></pre>

</div>
<div class="footer">
    <div class="meta">Generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Wed Jun 17 2015 16:34:49 GMT+0100 (BST)</div>
</div>
<script src="../../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../../sorter.js"></script>
</body>
</html>
